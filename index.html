<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="https://c.s-microsoft.com/favicon.ico?v2" />
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="game.css">
    <title>Cell-S-Dial</title>
  </head>
  <body>

    <canvas id="game"></canvas>

    <!-- <script src="game_logic.js"></script> -->
    <script>

      var canvas = document.getElementById("game");
      var drawingArea = canvas.getContext("2d");
      var fps = 20;
      var currentTick = 0;

      class SpriteFrameLocation
      {
        constructor(x, y, spriteWidth, spriteHeight)
        {
          this.x = x;
          this.y = y;
          this.spriteWidth = spriteWidth;
          this.spriteHeight = spriteHeight;
        }
      }

      var bullet = {
        x: 0,
        y: 0,
      }

      var player = 
      {
        x: 100,
        y: 100,
        left: false,
        up: false,
        right: false,
        down: false,
        fire: false,
        speed: 10,
        assets:
        {
          getSpriteSheet: function ()
          {
            let image = new Image();
            image.src = "Assets/Player_Ship_1.png";
            return image;
          },
          currentSprite: 0,
    //TODO: later on extract generic method for getting spritesheet along with each sprite coords
          getSpriteFrames: function ()
          {
            let spriteWidth = 32;
            let spriteHeight = 32;
            let rowsCount = 1;
            let columnsCount = 2;

            let spriteFrames = [];
            for(let row = 0; row < rowsCount; row++)
            {
              for(let column = 0; column < columnsCount; column++)
              {
                spriteFrames[row + column] = new SpriteFrameLocation
                (
                  row * spriteWidth,
                  column * spriteHeight,
                  spriteWidth,
                  spriteHeight
                );
              }
            }

            return spriteFrames;
          },
          getNextSprite: function ()
          {
            ++this.currentSprite;
            if(this.currentSprite == this.getSpriteFrames().length)
            {
                this.currentSprite = 0;
            }
            return this.getSpriteFrames()[this.currentSprite];
          }
        }
      };

      window.onload = function()
      {
          document.addEventListener("keydown", keydown);
          document.addEventListener("keyup", keyup);
          setInterval(gameloop, 1000 / fps);
      }

      function gameloop()
      {
          gamelogic();
          paintScreen();
      }

      function intersectRect(r1l, r1u, r1r, r1d, r2l, r2u, r2r, r2d)
      {
          return !(r2l > r1r || r2r < r1l || r2u > r1d || r2d < r1u)
      }

      function gamelogic()
      {
          if(player.left)
          {
            player.x -= player.speed;
          }
          if(player.right)
          {
            player.x += player.speed;
          }
          if(player.up)
          {
            player.y -= player.speed;
          }
          if(player.down)
          {
            player.y += player.speed;
          }
      }

      function keydown(event)
      {
          console.log(event.keyCode)
          switch(event.keyCode)
          {
              case 37: player.left = true; break;
              case 38: player.up = true; break;
              case 39: player.right = true; break;
              case 40: player.down = true; break;
              case 90: player.fire = true; break;
          }
      }

      function keyup(event)
      {
          switch(event.keyCode)
          {
              case 37: player.left = false; break;
              case 38: player.up = false; break;
              case 39: player.right = false; break;
              case 40: player.down = false; break;
              case 90: player.fire = false; break;
          }
      }

      function paintScreen()
      {
          drawingArea.fillStyle = "#000";
          drawingArea.fillRect(0, 0, canvas.width, canvas.height);

          let playerSpriteSheet = player.assets.getSpriteSheet();
          let playerSprite = player.assets.getNextSprite();

          drawingArea.drawImage(
            playerSpriteSheet,
            playerSprite.x,
            playerSprite.y,
            playerSprite.spriteWidth,
            playerSprite.spriteHeight,
            player.x,
            player.y,
            playerSprite.spriteWidth,
            playerSprite.spriteHeight);

            if(player.fire)
            {
              drawingArea.fillStyle = "#FFF";
              drawingArea.fillRect(bullet.x, bullet.y, 1, 1);
              bullet.y--;
            }
            else  
            {
              bullet.x = player.x + playerSprite.spriteWidth / 2;
              bullet.y = player.y - playerSprite.spriteHeight / 32;
            }

            currentTick++;
      }
    </script>

    <!-- <script>
      if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js', { scope: '/' });
      }
    </script> -->

  </body>
</html>